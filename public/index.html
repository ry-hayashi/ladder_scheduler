<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>24æ™‚é–“ãƒ©ãƒ€ãƒ¼ãƒ»ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼</title>
<meta name="description" content="1æ—¥ã®ç”Ÿæ´»é…åˆ†ã‚’ç¸¦ãƒ©ãƒ€ãƒ¼ã§å¯è¦–åŒ–ã™ã‚‹ç”Ÿæ´»ãƒªã‚ºãƒ ç®¡ç†ã‚¢ãƒ—ãƒª">
<meta name="theme-color" content="#1a1a2e">
<link rel="manifest" href="manifest.webmanifest">
<link rel="apple-touch-icon" href="icon-192.png">
<link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg-deep: #0f0f1a;
  --bg-card: #1a1a2e;
  --bg-surface: #232342;
  --bg-hover: #2a2a4a;
  --text-primary: #e8e6f0;
  --text-secondary: #9590b0;
  --text-muted: #6a6590;
  --accent: #7c6ff0;
  --accent-glow: rgba(124, 111, 240, 0.3);
  --free-color: #2a2a3e;
  --free-stripe: #333355;
  --border: #333355;
  --danger: #f05c6c;
  --success: #5cf0a0;
  --warning: #f0c05c;
  --radius: 12px;
  --radius-sm: 8px;
  --shadow: 0 4px 24px rgba(0,0,0,0.4);
  --font-body: 'Zen Maru Gothic', sans-serif;
  --font-mono: 'JetBrains Mono', monospace;
}

html { font-size: 15px; }
body {
  font-family: var(--font-body);
  background: var(--bg-deep);
  color: var(--text-primary);
  min-height: 100vh;
  -webkit-font-smoothing: antialiased;
}

/* Scrollbar */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

/* App shell */
#root { min-height: 100vh; }

.app-container {
  max-width: 520px;
  margin: 0 auto;
  padding: 16px 12px 100px;
}

.app-header {
  text-align: center;
  padding: 24px 0 20px;
  position: relative;
}

.app-title {
  font-size: 1.4rem;
  font-weight: 700;
  background: linear-gradient(135deg, #a78bfa, #7c6ff0, #60a5fa);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  letter-spacing: 0.02em;
}

.app-subtitle {
  font-size: 0.75rem;
  color: var(--text-muted);
  margin-top: 4px;
  letter-spacing: 0.05em;
}

/* Cards */
.card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px;
  margin-bottom: 12px;
  box-shadow: var(--shadow);
}

.card-title {
  font-size: 0.8rem;
  font-weight: 500;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.1em;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 6px;
}

/* Timeline ladder */
.timeline-container {
  position: relative;
  padding-left: 48px;
}

.time-axis {
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  width: 44px;
}

.time-label {
  position: absolute;
  left: 0;
  font-family: var(--font-mono);
  font-size: 0.65rem;
  color: var(--text-muted);
  transform: translateY(-50%);
  width: 44px;
  text-align: right;
  padding-right: 8px;
}

.timeline-track {
  position: relative;
  width: 100%;
  border-radius: var(--radius-sm);
  overflow: hidden;
  border: 1px solid var(--border);
}

.block-item {
  position: absolute;
  left: 0;
  right: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  cursor: pointer;
  transition: filter 0.15s, transform 0.15s;
  border-bottom: 1px solid rgba(0,0,0,0.15);
}

.block-item:hover {
  filter: brightness(1.15);
  z-index: 2;
}

.block-item.free-block {
  background: repeating-linear-gradient(
    -45deg,
    var(--free-color),
    var(--free-color) 4px,
    var(--free-stripe) 4px,
    var(--free-stripe) 8px
  );
  cursor: default;
}

.block-item.free-block:hover { filter: none; }

.block-label {
  font-size: 0.7rem;
  font-weight: 500;
  color: rgba(0,0,0,0.7);
  text-shadow: 0 1px 2px rgba(255,255,255,0.2);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  padding: 0 6px;
  pointer-events: none;
}

.block-label.free-label {
  color: var(--text-muted);
  font-style: italic;
  text-shadow: none;
  font-size: 0.6rem;
}

.block-time {
  position: absolute;
  right: 4px;
  top: 2px;
  font-family: var(--font-mono);
  font-size: 0.55rem;
  color: rgba(0,0,0,0.4);
  pointer-events: none;
}

.block-time.free-time {
  color: var(--text-muted);
  opacity: 0.6;
}

/* Forms */
.form-row {
  display: flex;
  gap: 8px;
  margin-bottom: 10px;
  align-items: end;
}

.form-group {
  display: flex;
  flex-direction: column;
  gap: 4px;
  flex: 1;
}

.form-label {
  font-size: 0.7rem;
  color: var(--text-secondary);
  font-weight: 500;
}

select, input[type="text"] {
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text-primary);
  font-family: var(--font-body);
  font-size: 0.85rem;
  padding: 8px 10px;
  outline: none;
  transition: border-color 0.2s;
  width: 100%;
}

select:focus, input[type="text"]:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 2px var(--accent-glow);
}

select { cursor: pointer; appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%239590b0'%3E%3Cpath d='M6 8L1 3h10z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 10px center;
  padding-right: 28px;
}

/* Buttons */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  padding: 9px 16px;
  border: none;
  border-radius: var(--radius-sm);
  font-family: var(--font-body);
  font-size: 0.8rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
  white-space: nowrap;
}

.btn-primary {
  background: var(--accent);
  color: white;
}
.btn-primary:hover { background: #6a5ce0; transform: translateY(-1px); }

.btn-secondary {
  background: var(--bg-surface);
  color: var(--text-secondary);
  border: 1px solid var(--border);
}
.btn-secondary:hover { background: var(--bg-hover); color: var(--text-primary); }

.btn-danger {
  background: transparent;
  color: var(--danger);
  border: 1px solid var(--danger);
}
.btn-danger:hover { background: var(--danger); color: white; }

.btn-sm { padding: 6px 10px; font-size: 0.7rem; }

.btn-block { width: 100%; }

/* Summary table */
.summary-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 6px;
}

.summary-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 10px;
  background: var(--bg-surface);
  border-radius: var(--radius-sm);
}

.summary-dot {
  width: 12px;
  height: 12px;
  border-radius: 3px;
  flex-shrink: 0;
}

.summary-name {
  font-size: 0.75rem;
  color: var(--text-secondary);
  flex: 1;
  min-width: 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.summary-time {
  font-family: var(--font-mono);
  font-size: 0.75rem;
  color: var(--text-primary);
  font-weight: 500;
}

/* Category list */
.cat-list { display: flex; flex-direction: column; gap: 6px; }

.cat-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 10px;
  background: var(--bg-surface);
  border-radius: var(--radius-sm);
}

.cat-color {
  width: 20px;
  height: 20px;
  border-radius: 4px;
  flex-shrink: 0;
  border: 2px solid rgba(255,255,255,0.1);
}

.cat-name { flex: 1; font-size: 0.85rem; }

/* Modal/Dialog */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  backdrop-filter: blur(4px);
  z-index: 100;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 16px;
  animation: fadeIn 0.15s ease;
}

@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

.modal-content {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px;
  width: 100%;
  max-width: 400px;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: 0 8px 40px rgba(0,0,0,0.6);
  animation: slideUp 0.2s ease;
}

@keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

.modal-title {
  font-size: 1rem;
  font-weight: 700;
  margin-bottom: 16px;
}

/* Warning banner */
.warning-banner {
  background: rgba(240, 192, 92, 0.1);
  border: 1px solid var(--warning);
  border-radius: var(--radius-sm);
  padding: 10px 14px;
  margin-bottom: 12px;
  font-size: 0.75rem;
  color: var(--warning);
  display: flex;
  align-items: center;
  gap: 8px;
}

.error-text { color: var(--danger); font-size: 0.75rem; margin-top: 4px; }

/* Tabs */
.tab-bar {
  display: flex;
  gap: 2px;
  background: var(--bg-surface);
  border-radius: var(--radius-sm);
  padding: 3px;
  margin-bottom: 16px;
}

.tab-btn {
  flex: 1;
  padding: 8px;
  border: none;
  border-radius: 6px;
  background: transparent;
  color: var(--text-muted);
  font-family: var(--font-body);
  font-size: 0.75rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
}

.tab-btn.active {
  background: var(--accent);
  color: white;
}

/* Import result */
.import-result {
  font-size: 0.8rem;
  line-height: 1.6;
  padding: 12px;
  background: var(--bg-surface);
  border-radius: var(--radius-sm);
  margin-top: 10px;
}

.import-result .success { color: var(--success); }
.import-result .skip { color: var(--warning); }
.import-result .error { color: var(--danger); }

/* Color picker grid */
.color-grid {
  display: grid;
  grid-template-columns: repeat(8, 1fr);
  gap: 6px;
  margin-top: 6px;
}

.color-swatch {
  width: 100%;
  aspect-ratio: 1;
  border-radius: 6px;
  border: 2px solid transparent;
  cursor: pointer;
  transition: transform 0.15s, border-color 0.15s;
}

.color-swatch:hover { transform: scale(1.15); }
.color-swatch.selected { border-color: white; transform: scale(1.15); }

/* Delete confirm */
.delete-zone {
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid var(--border);
  display: flex;
  gap: 8px;
  justify-content: flex-end;
}

/* Toast */
.toast {
  position: fixed;
  bottom: 24px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 10px 20px;
  font-size: 0.8rem;
  color: var(--text-primary);
  box-shadow: 0 8px 32px rgba(0,0,0,0.5);
  z-index: 200;
  animation: toastIn 0.3s ease;
}

@keyframes toastIn { from { transform: translateX(-50%) translateY(20px); opacity: 0; } to { transform: translateX(-50%) translateY(0); opacity: 1; } }

/* Settings gear */
.header-actions {
  position: absolute;
  right: 0;
  top: 50%;
  transform: translateY(-50%);
  display: flex;
  gap: 6px;
}

.icon-btn {
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: 8px;
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  color: var(--text-muted);
  transition: all 0.2s;
}

.icon-btn:hover { color: var(--text-primary); border-color: var(--accent); }


/* Template switcher */
.template-switcher { display: flex; gap: 6px; margin-bottom: 14px; overflow-x: auto; padding-bottom: 4px; scrollbar-width: none; }
.template-switcher::-webkit-scrollbar { display: none; }
.tmpl-chip {
  flex-shrink: 0; padding: 7px 14px; border-radius: 20px;
  border: 1.5px solid var(--border); background: var(--bg-card);
  color: var(--text-secondary); font-family: var(--font-body);
  font-size: 0.75rem; font-weight: 500; cursor: pointer;
  transition: all 0.2s; white-space: nowrap; max-width: 140px;
  overflow: hidden; text-overflow: ellipsis;
}
.tmpl-chip:hover { border-color: var(--accent); color: var(--text-primary); }
.tmpl-chip.active { background: var(--accent); border-color: var(--accent); color: white; }
.tmpl-chip-add {
  flex-shrink: 0; width: 32px; height: 32px; border-radius: 50%;
  border: 1.5px dashed var(--border); background: transparent;
  color: var(--text-muted); font-size: 1.1rem;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; transition: all 0.2s;
}
.tmpl-chip-add:hover { border-color: var(--accent); color: var(--accent); }

/* Template manage list in settings */
.tmpl-manage-item { display: flex; align-items: center; gap: 8px; padding: 10px 12px; background: var(--bg-surface); border-radius: var(--radius-sm); margin-bottom: 6px; }
.tmpl-manage-item.active-tmpl { border-left: 3px solid var(--accent); }
.tmpl-manage-name { flex: 1; font-size: 0.85rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.tmpl-manage-actions { display: flex; gap: 4px; flex-shrink: 0; }

/* Responsive */
@media (max-width: 400px) {
  .summary-grid { grid-template-columns: 1fr; }
  .form-row { flex-direction: column; }
  .color-grid { grid-template-columns: repeat(6, 1fr); }
}
</style>
</head>
<body>
<div id="root"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>

<script type="text/babel">
const { useState, useEffect, useCallback, useMemo, useRef } = React;

// â”€â”€â”€ Utilities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function minToHHmm(min) {
  const h = Math.floor(min / 60);
  const m = min % 60;
  return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
}

function hhmmToMin(s) {
  const [h, m] = s.split(':').map(Number);
  return h * 60 + m;
}

function roundTo15(min) {
  return Math.round(min / 15) * 15;
}

function uuid() {
  return crypto.randomUUID ? crypto.randomUUID() : 
    'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
      const r = Math.random()*16|0;
      return (c==='x'? r : (r&0x3|0x8)).toString(16);
    });
}

function generateFreeBlocks(blocks) {
  const sorted = [...blocks].sort((a,b) => a.startMin - b.startMin);
  const free = [];
  let cursor = 0;
  for (const b of sorted) {
    if (b.startMin > cursor) {
      free.push({ id: `free-${cursor}`, startMin: cursor, endMin: b.startMin, categoryId: '__FREE__', isFree: true });
    }
    cursor = Math.max(cursor, b.endMin);
  }
  if (cursor < 1440) {
    free.push({ id: `free-${cursor}`, startMin: cursor, endMin: 1440, categoryId: '__FREE__', isFree: true });
  }
  return free;
}

function calcSummary(blocks, categories) {
  const map = {};
  for (const b of blocks) {
    map[b.categoryId] = (map[b.categoryId] || 0) + (b.endMin - b.startMin);
  }
  const freeMin = generateFreeBlocks(blocks).reduce((s, b) => s + (b.endMin - b.startMin), 0);
  const result = categories.map(c => ({
    id: c.id, name: c.name, color: c.color,
    minutes: map[c.id] || 0
  })).filter(r => r.minutes > 0);
  if (freeMin > 0) result.push({ id: '__FREE__', name: 'FREE', color: '#444466', minutes: freeMin });
  return result;
}

function formatDuration(min) {
  const h = Math.floor(min / 60);
  const m = min % 60;
  if (h === 0) return `${m}åˆ†`;
  if (m === 0) return `${h}æ™‚é–“`;
  return `${h}æ™‚é–“${m}åˆ†`;
}

// â”€â”€â”€ Pale-tone colors â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const PALETTE = [
  '#FFB3BA','#FFDFBA','#FFFFBA','#BAFFC9','#BAE1FF','#D4BAFF','#FFB3E6','#C9BAFF',
  '#B3FFD9','#FFD9B3','#B3D4FF','#FFB3B3','#D4FFB3','#B3FFF0','#F0B3FF','#FFFAB3',
  '#F7C6C7','#C7E9B4','#B4D7E8','#E8B4D7','#D7E8B4','#B4E8D7','#E8D7B4','#C7B4E8',
];

// â”€â”€â”€ IndexedDB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const DB_NAME = 'LadderSchedulerV2';
const DB_VERSION = 1;

function openDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = (e) => {
      const db = e.target.result;
      if (!db.objectStoreNames.contains('store')) db.createObjectStore('store');
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

async function dbGet(key) {
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction('store','readonly');
    const req = tx.objectStore('store').get(key);
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

async function dbSet(key, val) {
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction('store','readwrite');
    tx.objectStore('store').put(val, key);
    tx.oncomplete = () => resolve();
    tx.onerror = () => reject(tx.error);
  });
}


async function dbDel(key) {
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction('store','readwrite');
    tx.objectStore('store').delete(key);
    tx.oncomplete = () => resolve();
    tx.onerror = () => reject(tx.error);
  });
}

// Migrate from old single-template DB
async function migrateV1() {
  return new Promise(resolve => {
    const req = indexedDB.open('LadderScheduler', 1);
    req.onerror = () => resolve(null);
    req.onsuccess = () => {
      const db = req.result;
      if (!db.objectStoreNames.contains('store')) { db.close(); resolve(null); return; }
      const tx = db.transaction('store','readonly');
      const s = tx.objectStore('store');
      const g = {};
      for (const key of ['categories','blocks','graphMeta','lastBackup']) {
        const r = s.get(key);
        r.onsuccess = () => { g[key] = r.result; };
      }
      tx.oncomplete = () => { db.close(); resolve((g.categories || g.blocks) ? g : null); };
    };
  });
}

async function loadAllData() {
  let existing = await dbGet('templates');
  if (!existing) {
    const v1 = await migrateV1();
    if (v1 && (v1.categories?.length || v1.blocks?.length)) {
      const id = 'migrated-default';
      const tmpl = { id, title: v1.graphMeta?.title || 'ç”Ÿæ´»ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ', createdAt: v1.graphMeta?.createdAt || new Date().toISOString() };
      await dbSet('templates', [tmpl]);
      await dbSet('categories', v1.categories || []);
      await dbSet('blocks:' + id, v1.blocks || []);
      await dbSet('activeTemplateId', id);
      if (v1.lastBackup) await dbSet('lastBackup', v1.lastBackup);
      existing = [tmpl];
    }
  }
  let templates = existing || [];
  if (templates.length === 0) {
    const t = { id: crypto.randomUUID(), title: 'å¹³æ—¥', createdAt: new Date().toISOString() };
    templates = [t]; await dbSet('templates', templates);
  }
  const activeId = (await dbGet('activeTemplateId')) || templates[0].id;
  const categories = (await dbGet('categories')) || [];
  const blocks = (await dbGet('blocks:' + activeId)) || [];
  const lastBackup = await dbGet('lastBackup');
  return { templates, activeTemplateId: activeId, categories, blocks, lastBackup };
}

// â”€â”€â”€ Time options â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const START_OPTIONS = [];
for (let m = 0; m <= 1425; m += 15) START_OPTIONS.push(m); // 0:00 ~ 23:45

const END_OPTIONS = [];
for (let m = 15; m <= 1440; m += 15) END_OPTIONS.push(m); // 0:15 ~ 24:00

// â”€â”€â”€ SVG Icons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const Icons = {
  plus: <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
  download: <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>,
  upload: <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"/></svg>,
  trash: <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>,
  settings: <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.32 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>,
  x: <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
  edit: <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
  copy: <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>,
  clock: <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
};

// â”€â”€â”€ MAIN APP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function App() {
  const [templates, setTemplates] = useState([]);
  const [activeId, setActiveIdRaw] = useState('');
  const [categories, setCategories] = useState([]);
  const [blocks, setBlocks] = useState([]);
  const [lastBackup, setLastBackup] = useState(null);
  const [loaded, setLoaded] = useState(false);
  const [tab, setTab] = useState('timeline');
  const [toast, setToast] = useState(null);
  const [showSettings, setShowSettings] = useState(false);

  useEffect(() => {
    loadAllData().then(d => {
      setTemplates(d.templates); setActiveIdRaw(d.activeTemplateId);
      setCategories(d.categories); setBlocks(d.blocks);
      setLastBackup(d.lastBackup); setLoaded(true);
    });
  }, []);

  const showToast = useCallback(msg => { setToast(msg); setTimeout(() => setToast(null), 2500); }, []);

  useEffect(() => { if (loaded) dbSet('categories', categories); }, [categories, loaded]);
  useEffect(() => { if (loaded && activeId) dbSet('blocks:' + activeId, blocks); }, [blocks, activeId, loaded]);
  useEffect(() => { if (loaded) dbSet('templates', templates); }, [templates, loaded]);
  useEffect(() => { if (loaded && activeId) dbSet('activeTemplateId', activeId); }, [activeId, loaded]);

  const switchTemplate = useCallback(async id => {
    if (id === activeId) return;
    const nb = (await dbGet('blocks:' + id)) || [];
    setActiveIdRaw(id); setBlocks(nb);
  }, [activeId]);

  const addTemplate = useCallback(title => {
    const id = uuid();
    setTemplates(p => [...p, { id, title: title || 'æ–°ã—ã„ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ', createdAt: new Date().toISOString() }]);
    dbSet('blocks:' + id, []);
    setActiveIdRaw(id); setBlocks([]);
    showToast('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸ');
  }, [showToast]);

  const duplicateTemplate = useCallback(async srcId => {
    const src = templates.find(t => t.id === srcId); if (!src) return;
    const id = uuid();
    const srcBlocks = (await dbGet('blocks:' + srcId)) || [];
    const newBlocks = srcBlocks.map(b => ({ ...b, id: uuid() }));
    await dbSet('blocks:' + id, newBlocks);
    setTemplates(p => [...p, { id, title: src.title + ' (ã‚³ãƒ”ãƒ¼)', createdAt: new Date().toISOString() }]);
    setActiveIdRaw(id); setBlocks(newBlocks);
    showToast('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’è¤‡è£½ã—ã¾ã—ãŸ');
  }, [templates, showToast]);

  const deleteTemplate = useCallback(async id => {
    if (templates.length <= 1) { showToast('æœ€å¾Œã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¯å‰Šé™¤ã§ãã¾ã›ã‚“'); return; }
    await dbDel('blocks:' + id);
    const nl = templates.filter(t => t.id !== id); setTemplates(nl);
    if (activeId === id) { const nb = (await dbGet('blocks:' + nl[0].id)) || []; setActiveIdRaw(nl[0].id); setBlocks(nb); }
    showToast('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
  }, [templates, activeId, showToast]);

  const renameTemplate = useCallback((id, title) => { setTemplates(p => p.map(t => t.id === id ? { ...t, title } : t)); }, []);

  const activeTmpl = useMemo(() => templates.find(t => t.id === activeId), [templates, activeId]);
  const sortedBlocks = useMemo(() => [...blocks].sort((a, b) => a.startMin - b.startMin), [blocks]);
  const displayBlocks = useMemo(() => { const f = generateFreeBlocks(sortedBlocks); return [...sortedBlocks, ...f].sort((a, b) => a.startMin - b.startMin); }, [sortedBlocks]);
  const summary = useMemo(() => calcSummary(sortedBlocks, categories), [sortedBlocks, categories]);
  const backupWarning = useMemo(() => { if (!lastBackup) return blocks.length > 0; return Date.now() - new Date(lastBackup).getTime() > 30 * 24 * 60 * 60 * 1000; }, [lastBackup, blocks]);
  const lastBlockEnd = useMemo(() => sortedBlocks.length === 0 ? 0 : sortedBlocks[sortedBlocks.length - 1].endMin, [sortedBlocks]);

  const addBlock = useCallback((startMin, endMin, categoryId) => {
    if (startMin >= endMin) return 'ã‚¨ãƒ©ãƒ¼: é–‹å§‹æ™‚åˆ»ã¯çµ‚äº†æ™‚åˆ»ã‚ˆã‚Šå‰ã«ã—ã¦ãã ã•ã„';
    if (startMin % 15 !== 0 || endMin % 15 !== 0) return 'ã‚¨ãƒ©ãƒ¼: 15åˆ†åˆ»ã¿ã«ã—ã¦ãã ã•ã„';
    if (!categories.find(c => c.id === categoryId)) return 'ã‚¨ãƒ©ãƒ¼: ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„';
    const nb = { id: uuid(), startMin, endMin, categoryId };
    let arr = [...blocks, nb].sort((a, b) => a.startMin - b.startMin);
    for (let i = 1; i < arr.length; i++) {
      if (arr[i].startMin < arr[i - 1].endMin) {
        arr[i] = { ...arr[i], startMin: arr[i - 1].endMin };
        if (arr[i].endMin <= arr[i].startMin) return 'ã‚¨ãƒ©ãƒ¼: ä»–ã®ãƒ–ãƒ­ãƒƒã‚¯ã¨é‡ãªã£ã¦ãŠã‚Šã€è‡ªå‹•èª¿æ•´ã§ãã¾ã›ã‚“ã€‚æ™‚é–“ã‚’å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚';
      }
    }
    setBlocks(arr); return null;
  }, [blocks, categories]);

  const deleteBlock = useCallback(id => { setBlocks(p => p.filter(b => b.id !== id)); }, []);

  // Export all templates
  const exportData = useCallback(async () => {
    const allBlocks = {};
    for (const t of templates) allBlocks[t.id] = (await dbGet('blocks:' + t.id)) || [];
    const data = { schemaVersion: 2, exportedAt: new Date().toISOString(), templates, activeTemplateId: activeId, categories, allBlocks };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob); const a = document.createElement('a');
    a.href = url; a.download = `ladder-scheduler-${new Date().toISOString().slice(0, 10)}.json`; a.click(); URL.revokeObjectURL(url);
    const now = new Date().toISOString(); setLastBackup(now); dbSet('lastBackup', now);
    showToast('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†');
  }, [templates, activeId, categories, showToast]);

  // Import (merge, supports v1 + v2)
  const importData = useCallback(async jsonStr => {
    try {
      const data = JSON.parse(jsonStr);
      const result = { catAdded: 0, catSkipped: 0, blockAdded: 0, blockDuplicate: 0, blockInvalid: 0, blockOverlap: 0, tmplAdded: 0, tmplSkipped: 0 };
      const isV1 = data.schemaVersion === 1 || (!data.templates && data.blocks);
      let newCats = [...categories];
      for (const cat of (data.categories || [])) {
        if (newCats.find(c => c.id === cat.id)) { result.catSkipped++; continue; }
        newCats.push({ id: cat.id, name: cat.name, color: cat.color }); result.catAdded++;
      }
      if (isV1) {
        let nb = [...blocks]; const added = [];
        for (const blk of (data.blocks || [])) {
          if (nb.find(b => b.id === blk.id)) { result.blockDuplicate++; continue; }
          if (blk.startMin == null || blk.endMin == null || blk.startMin < 0 || blk.endMin > 1440 || blk.startMin % 15 !== 0 || blk.endMin % 15 !== 0 || blk.startMin >= blk.endMin || !newCats.find(c => c.id === blk.categoryId)) { result.blockInvalid++; continue; }
          if ([...nb, ...added].some(e => blk.startMin < e.endMin && e.startMin < blk.endMin)) { result.blockOverlap++; continue; }
          added.push({ id: blk.id, startMin: blk.startMin, endMin: blk.endMin, categoryId: blk.categoryId }); result.blockAdded++;
        }
        setBlocks([...nb, ...added].sort((a, b) => a.startMin - b.startMin));
      } else {
        let newTmpls = [...templates]; const importBlocks = data.allBlocks || {};
        for (const tmpl of (data.templates || [])) {
          if (newTmpls.find(t => t.id === tmpl.id)) {
            result.tmplSkipped++;
            const existing = (await dbGet('blocks:' + tmpl.id)) || []; const added = [];
            for (const blk of (importBlocks[tmpl.id] || [])) {
              if (existing.find(b => b.id === blk.id)) { result.blockDuplicate++; continue; }
              if (blk.startMin == null || blk.endMin == null || blk.startMin < 0 || blk.endMin > 1440 || blk.startMin % 15 !== 0 || blk.endMin % 15 !== 0 || blk.startMin >= blk.endMin || !newCats.find(c => c.id === blk.categoryId)) { result.blockInvalid++; continue; }
              if ([...existing, ...added].some(e => blk.startMin < e.endMin && e.startMin < blk.endMin)) { result.blockOverlap++; continue; }
              added.push({ id: blk.id, startMin: blk.startMin, endMin: blk.endMin, categoryId: blk.categoryId }); result.blockAdded++;
            }
            if (added.length > 0) { const merged = [...existing, ...added].sort((a, b) => a.startMin - b.startMin); await dbSet('blocks:' + tmpl.id, merged); if (tmpl.id === activeId) setBlocks(merged); }
          } else {
            newTmpls.push({ id: tmpl.id, title: tmpl.title, createdAt: tmpl.createdAt }); result.tmplAdded++;
            const tb = [];
            for (const blk of (importBlocks[tmpl.id] || [])) {
              if (blk.startMin == null || blk.endMin == null || blk.startMin < 0 || blk.endMin > 1440 || blk.startMin % 15 !== 0 || blk.endMin % 15 !== 0 || blk.startMin >= blk.endMin || !newCats.find(c => c.id === blk.categoryId)) { result.blockInvalid++; continue; }
              if (tb.some(e => blk.startMin < e.endMin && e.startMin < blk.endMin)) { result.blockOverlap++; continue; }
              tb.push({ id: blk.id, startMin: blk.startMin, endMin: blk.endMin, categoryId: blk.categoryId }); result.blockAdded++;
            }
            await dbSet('blocks:' + tmpl.id, tb);
          }
        }
        setTemplates(newTmpls);
      }
      setCategories(newCats); return result;
    } catch (e) { return { error: e.message }; }
  }, [categories, blocks, templates, activeId]);

  if (!loaded) return <div style={{display:'flex',justifyContent:'center',alignItems:'center',height:'100vh',color:'var(--text-muted)'}}>èª­ã¿è¾¼ã¿ä¸­â€¦</div>;

  return (
    <div className="app-container">
      <header className="app-header">
        <h1 className="app-title">24h ãƒ©ãƒ€ãƒ¼ãƒ»ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼</h1>
        <p className="app-subtitle">ç”Ÿæ´»ãƒªã‚ºãƒ å¯è¦–åŒ–</p>
        <div className="header-actions">
          <button className="icon-btn" onClick={() => setShowSettings(true)} title="è¨­å®š">{Icons.settings}</button>
        </div>
      </header>

      <div className="template-switcher">
        {templates.map(t => (
          <button key={t.id} className={`tmpl-chip ${t.id === activeId ? 'active' : ''}`} onClick={() => switchTemplate(t.id)}>{t.title}</button>
        ))}
        <button className="tmpl-chip-add" onClick={() => addTemplate()} title="ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¿½åŠ ">+</button>
      </div>

      {backupWarning && <div className="warning-banner">âš  {lastBackup ? 'æœ€å¾Œã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰30æ—¥ä»¥ä¸ŠçµŒéã—ã¦ã„ã¾ã™' : 'ã¾ã ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒã‚ã‚Šã¾ã›ã‚“'}ã€‚ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚’ãŠã™ã™ã‚ã—ã¾ã™ã€‚</div>}

      <div className="tab-bar">
        <button className={`tab-btn ${tab === 'timeline' ? 'active' : ''}`} onClick={() => setTab('timeline')}>ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</button>
        <button className={`tab-btn ${tab === 'add' ? 'active' : ''}`} onClick={() => setTab('add')}>è¿½åŠ </button>
        <button className={`tab-btn ${tab === 'category' ? 'active' : ''}`} onClick={() => setTab('category')}>ã‚«ãƒ†ã‚´ãƒª</button>
        <button className={`tab-btn ${tab === 'data' ? 'active' : ''}`} onClick={() => setTab('data')}>ãƒ‡ãƒ¼ã‚¿</button>
      </div>

      {tab === 'timeline' && <TimelineTab displayBlocks={displayBlocks} categories={categories} summary={summary} onDeleteBlock={deleteBlock} />}
      {tab === 'add' && <AddBlockTab categories={categories} lastBlockEnd={lastBlockEnd} onAdd={addBlock} showToast={showToast} onSwitchTab={setTab} />}
      {tab === 'category' && <CategoryTab categories={categories} setCategories={setCategories} blocks={blocks} showToast={showToast} />}
      {tab === 'data' && <DataTab onExport={exportData} onImport={importData} lastBackup={lastBackup} showToast={showToast} />}

      {showSettings && (
        <SettingsModal templates={templates} activeId={activeId} activeTmpl={activeTmpl}
          onRename={renameTemplate} onDuplicate={duplicateTemplate} onDelete={deleteTemplate} onAddTemplate={addTemplate}
          blocks={blocks} setBlocks={setBlocks} categories={categories} setCategories={setCategories} setTemplates={setTemplates}
          onClose={() => setShowSettings(false)} showToast={showToast} />
      )}
      {toast && <div className="toast">{toast}</div>}
    </div>
  );
}

// â”€â”€â”€ Timeline Tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function TimelineTab({ displayBlocks, categories, summary, onDeleteBlock }) {
  const [selectedBlock, setSelectedBlock] = useState(null);
  const TRACK_HEIGHT = 720;
  const PX_PER_MIN = TRACK_HEIGHT / 1440;
  const catMap = useMemo(() => { const m = {}; categories.forEach(c => m[c.id] = c); return m; }, [categories]);
  const timeLabels = [];
  for (let h = 0; h <= 24; h += 3) timeLabels.push({ hour: h, y: (h * 60) * PX_PER_MIN });

  return (
    <>
      <div className="card">
        <div className="card-title">{Icons.clock} ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</div>
        <div className="timeline-container" style={{ height: TRACK_HEIGHT }}>
          <div className="time-axis">
            {timeLabels.map(t => <span key={t.hour} className="time-label" style={{ top: t.y }}>{String(t.hour).padStart(2, '0')}:00</span>)}
          </div>
          <div className="timeline-track" style={{ height: TRACK_HEIGHT }}>
            {displayBlocks.map(b => {
              const top = b.startMin * PX_PER_MIN, height = (b.endMin - b.startMin) * PX_PER_MIN;
              const cat = catMap[b.categoryId], isFree = b.isFree;
              const bgColor = isFree ? undefined : (cat?.color || '#666');
              const label = isFree ? 'FREE' : (cat?.name || '?');
              return (
                <div key={b.id} className={`block-item ${isFree ? 'free-block' : ''}`}
                  style={{ top, height: Math.max(height, 1), backgroundColor: isFree ? undefined : bgColor }}
                  onClick={() => !isFree && setSelectedBlock(b)}>
                  {height >= 14 && <span className={`block-label ${isFree ? 'free-label' : ''}`}>{label}</span>}
                  {height >= 24 && <span className={`block-time ${isFree ? 'free-time' : ''}`}>{minToHHmm(b.startMin)}-{minToHHmm(b.endMin)}</span>}
                </div>
              );
            })}
          </div>
        </div>
      </div>
      {summary.length > 0 && (
        <div className="card">
          <div className="card-title">ğŸ“Š é›†è¨ˆ</div>
          <div className="summary-grid">
            {summary.map(s => (
              <div key={s.id} className="summary-item">
                <div className="summary-dot" style={{ backgroundColor: s.color }} />
                <span className="summary-name">{s.name}</span>
                <span className="summary-time">{formatDuration(s.minutes)}</span>
              </div>
            ))}
          </div>
        </div>
      )}
      {selectedBlock && (
        <div className="modal-overlay" onClick={() => setSelectedBlock(null)}>
          <div className="modal-content" onClick={e => e.stopPropagation()}>
            <div className="modal-title">ãƒ–ãƒ­ãƒƒã‚¯è©³ç´°</div>
            <p style={{ fontSize: '0.85rem', marginBottom: 8 }}><strong>{catMap[selectedBlock.categoryId]?.name || '?'}</strong></p>
            <p style={{ fontSize: '0.8rem', color: 'var(--text-secondary)', marginBottom: 4 }}>
              {minToHHmm(selectedBlock.startMin)} ã€œ {minToHHmm(selectedBlock.endMin)}ï¼ˆ{formatDuration(selectedBlock.endMin - selectedBlock.startMin)}ï¼‰
            </p>
            <div className="delete-zone">
              <button className="btn btn-secondary btn-sm" onClick={() => setSelectedBlock(null)}>é–‰ã˜ã‚‹</button>
              <button className="btn btn-danger btn-sm" onClick={() => { onDeleteBlock(selectedBlock.id); setSelectedBlock(null); }}>{Icons.trash} å‰Šé™¤</button>
            </div>
          </div>
        </div>
      )}
    </>
  );
}

// â”€â”€â”€ Add Block Tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function AddBlockTab({ categories, lastBlockEnd, onAdd, showToast, onSwitchTab }) {
  const suggestedStart = lastBlockEnd < 1440 ? lastBlockEnd : 0;
  const [startMin, setStartMin] = useState(suggestedStart);
  const [endMin, setEndMin] = useState(Math.min(suggestedStart + 60, 1440));
  const [catId, setCatId] = useState(categories[0]?.id || '');
  const [error, setError] = useState('');

  useEffect(() => { const s = lastBlockEnd < 1440 ? lastBlockEnd : 0; setStartMin(s); setEndMin(Math.min(s + 60, 1440)); }, [lastBlockEnd]);
  useEffect(() => { if (!catId && categories.length) setCatId(categories[0].id); }, [categories, catId]);

  const handleSubmit = () => {
    setError('');
    if (!catId) { setError('ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
    const err = onAdd(startMin, endMin, catId);
    if (err) { setError(err); return; }
    showToast('ãƒ–ãƒ­ãƒƒã‚¯ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
  };

  if (categories.length === 0) return (
    <div className="card">
      <div className="card-title">{Icons.plus} ãƒ–ãƒ­ãƒƒã‚¯è¿½åŠ </div>
      <p style={{ fontSize: '0.85rem', color: 'var(--text-secondary)' }}>å…ˆã«ã‚«ãƒ†ã‚´ãƒªã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚</p>
      <button className="btn btn-primary btn-sm" style={{ marginTop: 12 }} onClick={() => onSwitchTab('category')}>ã‚«ãƒ†ã‚´ãƒªã‚’ä½œæˆ</button>
    </div>
  );

  return (
    <div className="card">
      <div className="card-title">{Icons.plus} ãƒ–ãƒ­ãƒƒã‚¯è¿½åŠ </div>
      <div className="form-row">
        <div className="form-group">
          <label className="form-label">é–‹å§‹æ™‚åˆ»</label>
          <select value={startMin} onChange={e => { const v = Number(e.target.value); setStartMin(v); if (endMin <= v) setEndMin(Math.min(v + 15, 1440)); }}>
            {START_OPTIONS.map(m => <option key={m} value={m}>{minToHHmm(m)}</option>)}
          </select>
        </div>
        <div className="form-group">
          <label className="form-label">çµ‚äº†æ™‚åˆ»</label>
          <select value={endMin} onChange={e => setEndMin(Number(e.target.value))}>
            {END_OPTIONS.filter(m => m > startMin).map(m => <option key={m} value={m}>{minToHHmm(m)}</option>)}
          </select>
        </div>
      </div>
      <div className="form-group" style={{ marginBottom: 12 }}>
        <label className="form-label">ã‚«ãƒ†ã‚´ãƒª</label>
        <select value={catId} onChange={e => setCatId(e.target.value)}>
          {categories.map(c => <option key={c.id} value={c.id}>â— {c.name}</option>)}
        </select>
      </div>
      {error && <p className="error-text">{error}</p>}
      <button className="btn btn-primary btn-block" onClick={handleSubmit}>{Icons.plus} ä¿å­˜</button>
    </div>
  );
}

// â”€â”€â”€ Category Tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function CategoryTab({ categories, setCategories, blocks, showToast }) {
  const [showAdd, setShowAdd] = useState(false);
  const [editCat, setEditCat] = useState(null);
  const [name, setName] = useState('');
  const [color, setColor] = useState(PALETTE[0]);

  const startAdd = () => { setName(''); setColor(PALETTE[Math.floor(Math.random() * PALETTE.length)]); setEditCat(null); setShowAdd(true); };
  const startEdit = c => { setName(c.name); setColor(c.color); setEditCat(c); setShowAdd(true); };
  const handleSave = () => {
    if (!name.trim()) return;
    if (editCat) { setCategories(p => p.map(c => c.id === editCat.id ? { ...c, name: name.trim(), color } : c)); showToast('ã‚«ãƒ†ã‚´ãƒªã‚’æ›´æ–°ã—ã¾ã—ãŸ'); }
    else { setCategories(p => [...p, { id: uuid(), name: name.trim(), color }]); showToast('ã‚«ãƒ†ã‚´ãƒªã‚’è¿½åŠ ã—ã¾ã—ãŸ'); }
    setShowAdd(false);
  };
  const handleDelete = id => {
    if (blocks.some(b => b.categoryId === id)) { showToast('ä½¿ç”¨ä¸­ã®ã‚«ãƒ†ã‚´ãƒªã¯å‰Šé™¤ã§ãã¾ã›ã‚“'); return; }
    setCategories(p => p.filter(c => c.id !== id)); showToast('ã‚«ãƒ†ã‚´ãƒªã‚’å‰Šé™¤ã—ã¾ã—ãŸ'); setShowAdd(false);
  };

  return (
    <>
      <div className="card">
        <div className="card-title" style={{ justifyContent: 'space-between' }}>
          <span>ğŸ· ã‚«ãƒ†ã‚´ãƒª</span>
          <button className="btn btn-primary btn-sm" onClick={startAdd}>{Icons.plus} è¿½åŠ </button>
        </div>
        {categories.length === 0 ? <p style={{ fontSize: '0.8rem', color: 'var(--text-muted)' }}>ã‚«ãƒ†ã‚´ãƒªãŒã‚ã‚Šã¾ã›ã‚“ã€‚è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</p> : (
          <div className="cat-list">
            {categories.map(c => (
              <div key={c.id} className="cat-item" onClick={() => startEdit(c)}>
                <div className="cat-color" style={{ backgroundColor: c.color }} />
                <span className="cat-name">{c.name}</span>
                <span style={{ color: 'var(--text-muted)', fontSize: '0.7rem' }}>{Icons.edit}</span>
              </div>
            ))}
          </div>
        )}
      </div>
      {showAdd && (
        <div className="modal-overlay" onClick={() => setShowAdd(false)}>
          <div className="modal-content" onClick={e => e.stopPropagation()}>
            <div className="modal-title">{editCat ? 'ã‚«ãƒ†ã‚´ãƒªç·¨é›†' : 'ã‚«ãƒ†ã‚´ãƒªè¿½åŠ '}</div>
            <div className="form-group" style={{ marginBottom: 12 }}>
              <label className="form-label">åå‰</label>
              <input type="text" value={name} onChange={e => setName(e.target.value)} placeholder="ä¾‹: ç¡çœ , ä»•äº‹, é£Ÿäº‹..." autoFocus />
            </div>
            <div className="form-group" style={{ marginBottom: 16 }}>
              <label className="form-label">ã‚«ãƒ©ãƒ¼</label>
              <div className="color-grid">
                {PALETTE.map(c => <div key={c} className={`color-swatch ${color === c ? 'selected' : ''}`} style={{ backgroundColor: c }} onClick={() => setColor(c)} />)}
              </div>
            </div>
            <div style={{ display: 'flex', gap: 8 }}>
              <button className="btn btn-primary" style={{ flex: 1 }} onClick={handleSave}>{editCat ? 'æ›´æ–°' : 'è¿½åŠ '}</button>
              <button className="btn btn-secondary" onClick={() => setShowAdd(false)}>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
            {editCat && <div className="delete-zone"><button className="btn btn-danger btn-sm" onClick={() => handleDelete(editCat.id)}>{Icons.trash} å‰Šé™¤</button></div>}
          </div>
        </div>
      )}
    </>
  );
}

// â”€â”€â”€ Data Tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function DataTab({ onExport, onImport, lastBackup, showToast }) {
  const [importResult, setImportResult] = useState(null);
  const fileRef = useRef();
  const handleFile = e => {
    const file = e.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = async ev => { const result = await onImport(ev.target.result); setImportResult(result); if (!result.error) showToast('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†'); };
    reader.readAsText(file); e.target.value = '';
  };

  return (
    <>
      <div className="card">
        <div className="card-title">{Icons.download} ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</div>
        <p style={{ fontSize: '0.8rem', color: 'var(--text-secondary)', marginBottom: 10 }}>å…¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’JSONã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚</p>
        {lastBackup && <p style={{ fontSize: '0.7rem', color: 'var(--text-muted)', marginBottom: 10 }}>æœ€çµ‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—: {new Date(lastBackup).toLocaleString('ja-JP')}</p>}
        <button className="btn btn-primary btn-block" onClick={onExport}>{Icons.download} JSONã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
      </div>
      <div className="card">
        <div className="card-title">{Icons.upload} ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆãƒãƒ¼ã‚¸ï¼‰</div>
        <p style={{ fontSize: '0.8rem', color: 'var(--text-secondary)', marginBottom: 4 }}>æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã«è¿½åŠ ï¼ˆä¸Šæ›¸ãã—ã¾ã›ã‚“ï¼‰ã€‚v1å½¢å¼ã«ã‚‚å¯¾å¿œã€‚</p>
        <p style={{ fontSize: '0.7rem', color: 'var(--text-muted)', marginBottom: 10 }}>åŒã˜IDã¯è‡ªå‹•ã‚¹ã‚­ãƒƒãƒ—ã€‚æ™‚é–“é‡è¤‡ã‚‚ã‚¹ã‚­ãƒƒãƒ—ã€‚</p>
        <input type="file" accept=".json" ref={fileRef} style={{ display: 'none' }} onChange={handleFile} />
        <button className="btn btn-secondary btn-block" onClick={() => fileRef.current?.click()}>{Icons.upload} JSONã‚’é¸æŠ</button>
        {importResult && !importResult.error && (
          <div className="import-result">
            {importResult.tmplAdded > 0 && <p><span className="success">âœ“ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¿½åŠ : {importResult.tmplAdded}ä»¶</span></p>}
            {importResult.tmplSkipped > 0 && <p><span className="skip">â†³ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¹ã‚­ãƒƒãƒ—: {importResult.tmplSkipped}ä»¶</span></p>}
            <p><span className="success">âœ“ ã‚«ãƒ†ã‚´ãƒªè¿½åŠ : {importResult.catAdded}ä»¶</span> / ã‚¹ã‚­ãƒƒãƒ—: {importResult.catSkipped}ä»¶</p>
            <p><span className="success">âœ“ ãƒ–ãƒ­ãƒƒã‚¯è¿½åŠ : {importResult.blockAdded}ä»¶</span></p>
            {importResult.blockDuplicate > 0 && <p><span className="skip">â†³ é‡è¤‡ã‚¹ã‚­ãƒƒãƒ—: {importResult.blockDuplicate}ä»¶</span></p>}
            {importResult.blockInvalid > 0 && <p><span className="skip">â†³ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³NG: {importResult.blockInvalid}ä»¶</span></p>}
            {importResult.blockOverlap > 0 && <p><span className="error">â†³ æ™‚é–“é‡è¤‡ã‚¹ã‚­ãƒƒãƒ—: {importResult.blockOverlap}ä»¶</span></p>}
            {importResult.blockOverlap > 0 && <p style={{ marginTop: 6 }} className="error">âš  æ™‚é–“ãŒé‡ãªã£ã¦ã„ã‚‹ãƒ–ãƒ­ãƒƒã‚¯ãŒã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã—ãŸ</p>}
          </div>
        )}
        {importResult?.error && <div className="import-result"><p className="error">ã‚¨ãƒ©ãƒ¼: {importResult.error}</p></div>}
      </div>
    </>
  );
}

// â”€â”€â”€ Settings Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function SettingsModal({ templates, activeId, activeTmpl, onRename, onDuplicate, onDelete, onAddTemplate, blocks, setBlocks, categories, setCategories, setTemplates, onClose, showToast }) {
  const [editingId, setEditingId] = useState(null);
  const [editTitle, setEditTitle] = useState('');
  const [confirmReset, setConfirmReset] = useState(false);
  const [showNewForm, setShowNewForm] = useState(false);
  const [newTmplName, setNewTmplName] = useState('');

  const startRename = t => { setEditingId(t.id); setEditTitle(t.title); };
  const saveRename = () => { if (editTitle.trim()) { onRename(editingId, editTitle.trim()); showToast('åå‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸ'); } setEditingId(null); };

  const handleReset = async () => {
    for (const t of templates) await dbDel('blocks:' + t.id);
    const id = uuid();
    const t = { id, title: 'å¹³æ—¥', createdAt: new Date().toISOString() };
    await dbSet('templates', [t]); await dbSet('blocks:' + id, []);
    await dbSet('categories', []); await dbSet('activeTemplateId', id);
    showToast('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ'); window.location.reload();
  };

  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal-content" onClick={e => e.stopPropagation()}>
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16 }}>
          <div className="modal-title" style={{ marginBottom: 0 }}>è¨­å®š</div>
          <button className="icon-btn" onClick={onClose} style={{ width: 28, height: 28 }}>{Icons.x}</button>
        </div>

        <div className="card-title" style={{ marginBottom: 8 }}>ğŸ“‹ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†</div>
        {templates.map(t => (
          <div key={t.id} className={`tmpl-manage-item ${t.id === activeId ? 'active-tmpl' : ''}`}>
            {editingId === t.id ? (
              <input type="text" value={editTitle} onChange={e => setEditTitle(e.target.value)}
                onKeyDown={e => { if (e.key === 'Enter') saveRename(); }} onBlur={saveRename} autoFocus
                style={{ flex: 1, fontSize: '0.85rem', padding: '4px 8px' }} />
            ) : (
              <span className="tmpl-manage-name">{t.title} {t.id === activeId && <span style={{ fontSize: '0.6rem', color: 'var(--accent)' }}>â— ç¾åœ¨</span>}</span>
            )}
            <div className="tmpl-manage-actions">
              <button className="btn btn-secondary btn-sm" onClick={() => startRename(t)} title="åå‰å¤‰æ›´">{Icons.edit}</button>
              <button className="btn btn-secondary btn-sm" onClick={() => onDuplicate(t.id)} title="è¤‡è£½">{Icons.copy}</button>
              {templates.length > 1 && <button className="btn btn-danger btn-sm" onClick={() => onDelete(t.id)} title="å‰Šé™¤">{Icons.trash}</button>}
            </div>
          </div>
        ))}

        {showNewForm ? (
          <div style={{ display: 'flex', gap: 8, marginTop: 8 }}>
            <input type="text" value={newTmplName} onChange={e => setNewTmplName(e.target.value)} placeholder="ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå" autoFocus
              onKeyDown={e => { if (e.key === 'Enter' && newTmplName.trim()) { onAddTemplate(newTmplName.trim()); setNewTmplName(''); setShowNewForm(false); onClose(); } }} />
            <button className="btn btn-primary btn-sm" onClick={() => { if (newTmplName.trim()) { onAddTemplate(newTmplName.trim()); setNewTmplName(''); setShowNewForm(false); onClose(); } }}>ä½œæˆ</button>
            <button className="btn btn-secondary btn-sm" onClick={() => setShowNewForm(false)}>Ã—</button>
          </div>
        ) : (
          <button className="btn btn-secondary btn-block btn-sm" style={{ marginTop: 8 }} onClick={() => setShowNewForm(true)}>{Icons.plus} ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’è¿½åŠ </button>
        )}

        <div style={{ marginTop: 16, paddingTop: 12, borderTop: '1px solid var(--border)' }}>
          <p style={{ fontSize: '0.7rem', color: 'var(--text-muted)', marginBottom: 4 }}>ç¾åœ¨ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ: {activeTmpl?.title} / ãƒ–ãƒ­ãƒƒã‚¯æ•°: {blocks.length}</p>
          <p style={{ fontSize: '0.7rem', color: 'var(--text-muted)', marginBottom: 16 }}>ã‚«ãƒ†ã‚´ãƒªæ•°: {categories.length}ï¼ˆå…¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå…±é€šï¼‰</p>
        </div>

        <div style={{ borderTop: '1px solid var(--border)', paddingTop: 16 }}>
          {!confirmReset ? (
            <button className="btn btn-danger btn-block btn-sm" onClick={() => setConfirmReset(true)}>{Icons.trash} å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤</button>
          ) : (
            <div>
              <p style={{ fontSize: '0.8rem', color: 'var(--danger)', marginBottom: 8 }}>æœ¬å½“ã«å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚</p>
              <div style={{ display: 'flex', gap: 8 }}>
                <button className="btn btn-danger" style={{ flex: 1 }} onClick={handleReset}>å‰Šé™¤ã™ã‚‹</button>
                <button className="btn btn-secondary" onClick={() => setConfirmReset(false)}>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
              </div>
            </div>
          )}
        </div>
      </div>
    </div>
  );
}

// â”€â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ReactDOM.createRoot(document.getElementById('root')).render(<App />);

</script>

<script>
// â”€â”€â”€ Service Worker Registration â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js').catch(() => {});
  });
}
</script>
</body>
</html>
